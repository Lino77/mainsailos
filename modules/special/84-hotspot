#!/bin/bash
set -xe
export LC_ALL=C

########################################
# Functions and Basic Configuration    #
########################################

# Load common functions and set up cleanup trap
source /common.sh
install_cleanup_trap

# Load additional configuration (e.g., BASE_USER)
source /files/00-config

# --- 1. Variablen aus der Build-Umgebung oder Default ---
# Diese können in der config-Datei des Build-Systems überschrieben werden
SSID=${WIFI_SSID_AP:-"RatOS"}
PASS=${WIFI_PASSWORD_AP:-"raspberry"}
COUNTRY=${WIFI_COUNTRY:-"DE"}

# --- 2. Installation ---
# Haveged hinzugefügt für schnellere Zufallszahlen (wichtig für hostapd Start)
apt-get update && apt-get install -y hostapd dnsmasq iw haveged

# --- 3. Hostapd Konfiguration ---
cat <<EOF > /etc/hostapd/hostapd.conf
interface=wlan0
driver=nl80211
ssid=${SSID}
hw_mode=g
channel=7
wmm_enabled=0
macaddr_acl=0
auth_algs=1
ignore_broadcast_ssid=0
wpa=2
wpa_passphrase=${PASS}
wpa_key_mgmt=WPA-PSK
wpa_pairwise=TKIP
rsn_pairwise=CCMP
country_code=${COUNTRY}
EOF

sed -i 's|#DAEMON_CONF=""|DAEMON_CONF="/etc/hostapd/hostapd.conf"|' /etc/default/hostapd

# --- 4. Dnsmasq Konfiguration (DHCP Fix) ---
cat <<EOF > /etc/dnsmasq.conf
interface=wlan0
bind-dynamic
domain-needed
bogus-priv
dhcp-range=192.168.50.10,192.168.50.50,12h
EOF

# --- 5. Das AutoHotspot Switch-Skript (NetworkManager Edition) ---
cat <<'EOF' > /usr/bin/autohotspot
#!/bin/bash
WLAN_IFACE="wlan0"
ETH_IFACE="eth0"

# Warte auf Initialisierung
sleep 5

echo "Prüfe Netzwerkstatus..."

# A. CHECK ETHERNET
if [ -d /sys/class/net/$ETH_IFACE ] && [ "$(cat /sys/class/net/$ETH_IFACE/carrier 2>/dev/null)" = "1" ]; then
    echo "Ethernet aktiv. Beende."
    exit 0
fi

# B. CHECK WLAN CLIENT (NetworkManager Check)
WLAN_STATE=$(nmcli -t -f DEVICE,STATE dev | grep "^$WLAN_IFACE:connected" || true)
if [ -n "$WLAN_STATE" ]; then
    echo "WLAN bereits verbunden. Beende."
    exit 0
fi

# C. START HOTSPOT
echo "Kein Netzwerk gefunden. Starte Hotspot..."

# NM für wlan0 deaktivieren & RF-Kill lösen
nmcli dev set $WLAN_IFACE managed no
rfkill unblock wifi

# Dienste vorbereiten (Unmask falls im Build-Prozess maskiert)
systemctl unmask dnsmasq hostapd >/dev/null 2>&1
systemctl stop dnsmasq hostapd 2>/dev/null

# Interface IP setzen (Zwingend für DHCP/dnsmasq)
ip link set $WLAN_IFACE down
ip addr flush dev $WLAN_IFACE
ip addr add 192.168.50.1/24 brd + dev $WLAN_IFACE
ip link set $WLAN_IFACE up
sleep 2

# DHCP Server starten
rm -f /var/lib/misc/dnsmasq.leases
systemctl restart dnsmasq

# WLAN Hotspot starten
if ! systemctl restart hostapd; then
    # Fallback falls systemd klemmt
    /usr/sbin/hostapd -B /etc/hostapd/hostapd.conf
fi

echo "Hotspot aktiv auf 192.168.50.1"
EOF

chmod +x /usr/bin/autohotspot

# --- 6. Systemd Service Integration ---
cat <<EOF > /etc/systemd/system/autohotspot.service
[Unit]
Description=AutoHotspot Check for RatOS
# Wichtig: Nach NetworkManager starten, damit nmcli funktioniert
After=NetworkManager.service NetworkManager-wait-online.service
Wants=NetworkManager.service

[Service]
Type=oneshot
ExecStart=/usr/bin/autohotspot
RemainAfterExit=yes

[Install]
WantedBy=multi-user.target
EOF

# Dienste für den ersten Start vorbereiten
# Wir maskieren sie hier, damit nur das Skript sie starten darf
systemctl mask hostapd dnsmasq
systemctl enable autohotspot.service

echo "Module 84-autohotspot integrated successfully."
