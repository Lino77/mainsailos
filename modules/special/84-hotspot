!/bin/bash
set -xe
export LC_ALL=C

########################################
# Functions and Basic Configuration    #
########################################

# Load common functions and set up cleanup trap
source /common.sh
install_cleanup_trap

# Load additional configuration (e.g., BASE_USER)
source /files/00-config

# --- 1. Variablen aus der Build-Umgebung oder Default ---
# Diese können in der config-Datei des Build-Systems überschrieben werden
SSID=${WIFI_SSID_AP:-"RatOS"}
PASS=${WIFI_PASSWORD_AP:-"raspberry"}
COUNTRY=${WIFI_COUNTRY:-"DE"}
IP_ADDR="192.168.50.1"

# --- 2. Installation der benötigten Pakete ---
# Im Build-Prozess von MainsailOS geschieht dies meist über 'install_packages'
apt-get update && apt-get install -y hostapd dnsmasq iw

# --- 3. Hostapd Konfiguration (Zugangspunkt) ---
cat <<EOF > /etc/hostapd/hostapd.conf
interface=wlan0
driver=nl80211
ssid=${SSID}
hw_mode=g
channel=7
wmm_enabled=0
macaddr_acl=0
auth_algs=1
ignore_broadcast_ssid=0
wpa=2
wpa_passphrase=${PASS}
wpa_key_mgmt=WPA-PSK
wpa_pairwise=TKIP
rsn_pairwise=CCMP
country_code=${COUNTRY}
EOF

# Pfad in Standard-Config hinterlegen
sed -i 's|#DAEMON_CONF=""|DAEMON_CONF="/etc/hostapd/hostapd.conf"|' /etc/default/hostapd

# --- 4. Dnsmasq Konfiguration (DHCP/DNS) ---
cat <<EOF > /etc/dnsmasq.conf
interface=wlan0
bind-dynamic
domain-needed
bogus-priv
dhcp-range=192.168.50.10,192.168.50.50,12h
EOF

# --- 5. Das AutoHotspot Switch-Skript (Kernlogik) ---
# Ersetzt die interaktiven Menüs durch eine Boot-Entscheidung
cat <<'EOF' > /usr/bin/autohotspot
#!/bin/bash
# Logic to switch between Client and AP mode
IFACE="wlan0"

# Stoppe laufende AP-Dienste für den Scan
systemctl stop hostapd dnsmasq
ip link set $IFACE down
ip addr flush dev $IFACE
ip link set $IFACE up

# Warte kurz auf Initialisierung
sleep 2

# Scan nach SSIDs, die in /etc/wpa_supplicant/wpa_supplicant.conf hinterlegt sind
# Wir suchen nach Übereinstimmungen zwischen Scan und Config
WPA_CONF="/etc/wpa_supplicant/wpa_supplicant.conf"
FOUND_SSID=$(iw dev $IFACE scan | grep SSID | awk -F': ' '{print $2}' | xargs -I {} grep -q 'ssid="{}"' $WPA_CONF && echo "YES" || true)

if [[ "$FOUND_SSID" == *"YES"* ]]; then
    echo "Known WiFi found. Connecting as client..."
    # Standard-Netzwerkdienst übernimmt (z.B. dhcpcd oder NetworkManager)
else
    echo "No known WiFi found. Starting Hotspot..."
    ip addr add 192.168.50.1/24 brd + dev $IFACE
    systemctl start dnsmasq
    systemctl start hostapd
fi
EOF

chmod +x /usr/bin/autohotspot

# --- 6. Systemd Service Integration ---
# Damit das Skript bei jedem Boot die Lage prüft
cat <<EOF > /etc/systemd/system/autohotspot.service
[Unit]
Description=AutoHotspot Check for MainsailOS
After=network-pre.target
Before=network.target
Wants=network.target

[Service]
Type=oneshot
ExecStart=/usr/bin/autohotspot
RemainAfterExit=yes

[Install]
WantedBy=multi-user.target
EOF

# Dienste für den ersten Start vorbereiten
systemctl mask hostapd dnsmasq # Verhindert den automatischen Start ohne Skript-Prüfung
systemctl enable autohotspot.service

echo "Module 84-autohotspot integrated successfully."
