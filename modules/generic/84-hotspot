!/bin/bash
set -xe
export LC_ALL=C

########################################
# Functions and Basic Configuration    #
########################################

# Load common functions and set up cleanup trap
source /common.sh
install_cleanup_trap

# Load additional configuration (e.g., BASE_USER)
source /files/00-config

echo_green "Installing RPI MCU service"

pushd "/home/${BASE_USER}/klipper" &> /dev/null || exit 1

echo "flashing rpi-mcu"
cp -f /home/"${BASE_USER}"/printer_data/config/RatOS/boards/rpi/firmware.config /home/"${BASE_USER}"/klipper/.config
make olddefconfig
make clean
# Reset ownership so make flash doesn't complain
chown pi:pi -R /home/pi/klipper
make flash
popd

pushd "/home/${BASE_USER}/klipper" &> /dev/null || exit 1
sudo cp "./scripts/klipper-mcu.service" /etc/systemd/system/klipper_mcu.service
sudo systemctl enable klipper_mcu.service
popd



# Reset ownership
chown pi:pi -R /home/pi/klipper
